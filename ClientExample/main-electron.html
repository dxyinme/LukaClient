<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="./layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="css/WS.css">
    <link rel="stylesheet" type="text/css" href="css/MSG.css">
</head>
<body>
<h1 style="text-align: center;">Luka hello!</h1>
<form style="text-align: center;">
    <p id="nameIs"></p>
</form>
<div id="main">
    <div id="main-header">
        <input id="main-target" type="text" value="发送对象">
    </div>
    <div id="main-message-body">
    </div>
    <div id="main-message">
        <textarea id="message" onkeydown="keydown()"></textarea>
    </div>
    <button id="send-button" onclick="send()">SEND</button>
    <select id="select-target-type">
        <option value="single">SingleChat</option>
        <option value="group">GroupChat</option>
    </select>
    <button id="change-target-button" onclick="changeTarget()">changeTarget</button>
    <button id="group-operator-button" onclick="showGroupOperation()">showGroupOperation</button>
    <!--<button id="change-target-button" onclick="testMention()">test mention</button>-->
</div>
<!-- script -->
<script src="./layui/layui.js"></script>
<script src="js/Luka-IM.js"></script>
<script src="js/MSGShow.js"></script>

<script type="text/javascript">
    let mention_box = {
        area: ['340px', '415px'],
        shade: 0,
        offset: 'rb',
        time: 2000
    };
    let target_now = "";

    let ipcMsg = new IpcMsg();
    let msgShow = new MSGShow();

    let chat_msg_type = document.getElementById('select-target-type');
    let main_target = document.getElementById('main-target');
    let main_message_body = document.getElementById('main-message-body');
    let change_target_button = document.getElementById('change-target-button');

    function loginFinished(msg) {
        document.getElementById('nameIs').innerHTML = '<h2>' + msg['Name'] + '</h2>';
    }

    function syncMainBody() {
        main_message_body.scrollTop = main_message_body.scrollHeight;
    }

    function testMention() {
        mention({
            msgType: LukaSingle,
            content: utf8_to_b64("Luka 你好呀"),
            msgContentType: LukaText,
            from: "kaka"
        })
    }

    function mention(msg) {
        let From, Content;
        if(msg['msgType'] === LukaGroup) {
            From = msg['groupName'];
        } else {
            From = msg['from'];
        }
        if(msg['msgContentType'] === LukaText) {
            Content = b64_to_utf8(msg['content'])
        } else if(msg['msgContentType'] === LukaImg) {
            Content = "[图片]"
        }
        layui.use(['layer'], function(){
            const layer = layui.layer;
            layer.msg('<p>' + From + '</p>' + '<p>' + Content + '</p>', mention_box);
        });
    }

    function showGroupOperation() {
        astilectron.sendMessage(ipcMsg.OpenNewWindowMsg(ipcMsg.TypeWindowGroupWindow));
    }

    function changeTarget() {
        change_target_button.disabled = true;
        target_now = main_target.value;
        main_message_body.innerHTML = "";
        let chatType = document.getElementById('select-target-type').value;
        // let chatType = $('#select-target-type').val('value');
        let ret = "";
        if(chatType === "single") {
            ret = ipcMsg.MessageRequiredMsg(target_now, LukaSingle);
        } else {
            ret = ipcMsg.MessageRequiredMsg(target_now, LukaGroup);
        }
        astilectron.sendMessage(ret);
        syncMainBody();
        // button change target will alive after 2 second
        setTimeout(function () {
            change_target_button.disabled = false;
        }, 2000);
    }

    function recvMessage(msg) {
        let self = document.getElementById('nameIs').innerText, isSelf;
        if(msg['from'] === self) {
            isSelf = true;
        } else {
            isSelf = false;
        }
        if(msg['msgType'] === LukaSingle) {
            if (msg['from'] === target_now || msg['from'] === self) {
                main_message_body.innerHTML += (msgShow.MsgBox(msg['from'], msg['target'],
                    b64_to_utf8(msg['content']), isSelf));
            } else {
                mention(msg);
            }
        } else {
            if (msg['groupName'] === target_now || msg['from'] === self) {
                main_message_body.innerHTML += (msgShow.MsgBox(msg['from'], msg['target'],
                    b64_to_utf8(msg['content']), isSelf));
            } else {
                mention(msg);
            }
        }
        syncMainBody();
    }

    function send() {
        let msg = document.getElementById('message').value;
        const from = document.getElementById('nameIs').innerText;
        const target = target_now;
        msg = msg.replace(/[\r\n]/g,"");
        if(msg.length === 0) {
            document.getElementById('message').value = "";
            return
        }
        astilectron.sendMessage(ipcMsg.IMMsg(document.getElementById('nameIs').innerText,
            target, msg, chat_msg_type.value));
        // console.log(document.getElementById('nameIs').innerText);
        // ipcMsg.IMMsg(document.getElementById('nameIs').innerText, target, msg);
        main_message_body.innerHTML += (msgShow.MsgBox(from, target, msg, true));
        document.getElementById('message').value = "";
        syncMainBody()
    }

    function keydown() {
        // body...
        let event = window.event ? window.event : event;
        if(event.keyCode === 13) {
            send();
        }
    }

    // Message Receive
    document.addEventListener('astilectron-ready', function () {
        astilectron.onMessage(function (message) {
            const msg = message['Msg'];
            switch (message['Type']) {
                case ipcMsg.TypeLoginFinished:
                    loginFinished(msg);
                    break;
                case ipcMsg.TypeMessage:
                    recvMessage(msg);
                    break;
                case ipcMsg.TypeErr:
                    ipcMsg.ShowErr(msg);
                    break
            }
        });
    })
</script>
</body>
</html>