<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/video.css">
</head>

<body>
<br>
<div id="video-element">
    <video id="now-user-video" autoplay controls playsinline></video>
    <canvas id="now-snapshot" hidden></canvas>
</div>
<br>
<div id="controller-element">
    <button id="btn-start-recording">Start Recording</button>
    <button id="btn-pause-recording" disabled>pause</button>
    <button id="btn-stop-recording" disabled>Stop Recording</button>
    <label>
        <input type="file" onchange="loadVideo()">
    </label>
</div>
<script src="js/Luka-IM.js"></script>
<script src="js/RecordRTC.js"></script>
<script type="text/javascript">

    let ipcMsg = new IpcMsg();
    let video = document.getElementById('now-user-video');
    let snapshot = document.getElementById('now-snapshot');
    let pauseButton = document.getElementById('btn-pause-recording');
    let stopButton = document.getElementById('btn-stop-recording');
    let startButton = document.getElementById('btn-start-recording');

    let recorder;
    let isOnRecord = false;
    let fileReader = new FileReader();

    function loadVideo() {
        const preview = document.getElementById('now-user-video');
        const file = document.querySelector('input[type=file]').files[0];
        const reader = new FileReader();

        reader.addEventListener("load", function () {
            preview.src = reader.result;
        }, false);

        if (file) {
            reader.readAsDataURL(file);
        }
    }
    
    function initFileReader() {
        fileReader.onload = function () {
            console.log('onload');
            astilectron.sendMessage(ipcMsg.VideoMsg('test', fileReader.result));
        };

        fileReader.onprogress = function () {
            console.log('onprogress');
        };
    }

    function captureCamera(callback) {
        navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true
        }).then(function(camera) {
            callback(camera);
        }).catch(function(error) {
            alert('Unable to capture your camera. Please check console logs.');
            console.error(error);
        });
    }

    function stopRecordingCallback() {
        video.src = video.srcObject = null;
        video.muted = false;
        video.volume = 1;
        let recorderBlob = recorder.getBlob();
        video.src = URL.createObjectURL(recorderBlob);
        fileReader.readAsArrayBuffer(recorderBlob);
        recorder.camera.stop();
        recorder.destroy();

        video.hidden = false;
        startButton.disabled = false;
        pauseButton.innerHTML = "pause";
        pauseButton.disabled = true;

        recorder = null;
    }

    function startRecording() {
        captureCamera(function(camera) {
            video.muted = true;
            video.volume = 0;
            video.srcObject = camera;
            recorder = RecordRTC(camera, {
                type: 'video'
            });
            recorder.startRecording();
            recorder.camera = camera;
            initFileReader();
            stopButton.disabled = false;
            pauseButton.disabled = false;
        });
    }

    pauseButton.onclick = function() {
        if(this.innerHTML === "pause") {
            this.innerHTML = "go on";
            video.hidden = true;
            snapshot.hidden = false;
            let ctx = snapshot.getContext('2d');
            console.log(video.videoWidth + " " + video.videoHeight);
            snapshot.height = video.videoHeight;
            snapshot.width = video.videoWidth;
            ctx.drawImage(video, 0, 0, snapshot.width, snapshot.height);
            recorder.pauseRecording();
        } else {
            this.innerHTML = "pause";
            snapshot.hidden = true;
            video.hidden = false;
            recorder.resumeRecording();
        }
    };

    startButton.onclick = function() {
        this.disabled = true;
        isOnRecord = true;
        startRecording();
    };

    stopButton.onclick = function() {
        this.disabled = true;
        isOnRecord = false;
        recorder.stopRecording(stopRecordingCallback);
        // startRecording();
    };
</script>

</body>
</html>